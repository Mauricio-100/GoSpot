#!/bin/sh

# GoSpot Script v2.1 (Plus Robuste) pour iSH Shell
# Par Mauricio

# Couleurs avec printf pour une meilleure compatibilit√©
GREEN() { printf "\033[1;32m%s\033[0m\n" "$1"; }
YELLOW() { printf "\033[1;33m%s\033[0m\n" "$1"; }
RED() { printf "\033[1;31m%s\033[0m\n" "$1"; }
INFO() { printf "%s\n" "$1"; }

# NOUVEAU : V√©rification des d√©pendances
check_dependencies() {
    for cmd in ssh sshd ssh-keygen ssh-copy-id ip arp; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
            RED "ERREUR : La commande '$cmd' est introuvable."
            YELLOW "Veuillez installer les d√©pendances avec : apk add openssh iproute2"
            exit 1
        fi
    done
}

run_server() {
    GREEN "--- D√©marrage de GoSpot en mode SERVEUR ---"
    YELLOW "ACTION : Assurez-vous d'avoir activ√© le 'Partage de connexion' dans les R√©glages."
    
    if ! pgrep -f "sshd" > /dev/null; then
        INFO "D√©marrage du serveur SSH (sshd)..."
        [ ! -f "/etc/ssh/ssh_host_rsa_key" ] && ssh-keygen -A
        sshd
        GREEN "Serveur SSH d√©marr√©."
    else
        GREEN "Le serveur SSH est d√©j√† en cours d'ex√©cution."
    fi
    
    SERVER_IP=$(ip a | grep -o '172.20.10.1')
    INFO "\n‚úÖ Serveur pr√™t !"
    INFO "En attente d'un client..."
    GREEN "Mon adresse IP sur ce r√©seau est : $SERVER_IP"
}

run_client() {
    GREEN "--- D√©marrage de GoSpot en mode CLIENT ---"
    YELLOW "ACTION : Assurez-vous d'√™tre connect√© au Wi-Fi du t√©l√©phone serveur.\n"
    
    INFO "üïµÔ∏è  Recherche d'une cl√© SSH existante..."
    SSH_KEY_PATH=$(find / -type f \( -name "id_ed25519" -o -name "id_rsa" \) 2>/dev/null | head -n 1)

    if [ -z "$SSH_KEY_PATH" ]; then
        YELLOW "Aucune cl√© SSH trouv√©e. Cr√©ation d'une nouvelle cl√© (ed25519)..."
        mkdir -p "$HOME/.ssh"; chmod 700 "$HOME/.ssh"
        ssh-keygen -t ed25519 -N "" -f "$HOME/.ssh/id_ed25519"
        SSH_KEY_PATH="$HOME/.ssh/id_ed25519"
        GREEN "Nouvelle cl√© cr√©√©e √† : $SSH_KEY_PATH"
    else
        GREEN "Cl√© trouv√©e ! Utilisation de : $SSH_KEY_PATH"
    fi
    PUBLIC_KEY_PATH="${SSH_KEY_PATH}.pub"
    if [ ! -f "$PUBLIC_KEY_PATH" ]; then
        RED "ERREUR : La cl√© publique (.pub) pour $SSH_KEY_PATH est manquante !"
        exit 1
    fi

    INFO "\nRecherche du serveur GoSpot sur le r√©seau..."
    sleep 2
    SERVER_IP=$(arp -a | grep -o '172.20.10.1')

    if [ -z "$SERVER_IP" ]; then
        RED "ERREUR : Serveur introuvable. √ätes-vous bien connect√© au Partage de connexion ?"
        exit 1
    fi
    
    GREEN "Serveur trouv√© ! Adresse : $SERVER_IP"
    YELLOW "\nNOTE : La premi√®re fois, vous devrez entrer le mot de passe 'root' du serveur."
    
    ssh-copy-id -o ConnectTimeout=5 -o StrictHostKeyChecking=no -i "$PUBLIC_KEY_PATH" root@$SERVER_IP
    
    if [ $? -eq 0 ]; then
        GREEN "Cl√© autoris√©e ! Connexion en cours..."
        ssh -i "$SSH_KEY_PATH" root@$SERVER_IP
    else
        RED "La copie de la cl√© a √©chou√©. V√©rifiez le mot de passe du serveur."
    fi
}

# Logique principale
check_dependencies
case "$1" in
    serve) run_server ;;
    connect) run_client ;;
    *)
        INFO "Usage: GoS [commande]"
        INFO "\nCommandes disponibles :"
        INFO "  serve    : D√©marre en mode serveur (sur le tel qui partage la connexion)"
        INFO "  connect  : D√©marre en mode client (sur le tel qui se connecte au Wi-Fi)"
        ;;
esac
